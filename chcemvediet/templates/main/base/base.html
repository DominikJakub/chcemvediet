{# vim: set filetype=htmldjango :#}
{% load static from staticfiles %}
{% load addtoblock render_block from sekizai_tags %}

{% comment %}
 %
 % Context:
 %  -- None
 %
{% endcomment %}

{# JQuery #}
{% addtoblock "js" %}<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>{% endaddtoblock %}

{# JQuery UI #}
{% addtoblock "css" %}<link href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/smoothness/jquery-ui.min.css" rel="stylesheet">{% endaddtoblock %}
{% addtoblock "js" %}<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>{% endaddtoblock %}
{% addtoblock "js" %}<script src="{% static 'main/3part/jqueryui/1.10.3/datepicker-sk.js' %}"></script>{% endaddtoblock %}

{# Bootstrap #}
{% addtoblock "css" %}<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">{% endaddtoblock %}
{% addtoblock "js" %}<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>{% endaddtoblock %}

{# JQuery File Upload (Requires: jquery.ui.widget.js)  #}
{% addtoblock "js" %}<script src="{% static 'main/3part/jqueryplugins/jquery.iframe-transport.js' %}"></script>{% endaddtoblock %}
{% addtoblock "js" %}<script src="{% static 'main/3part/jqueryplugins/jquery.fileupload.js' %}"></script>{% endaddtoblock %}

{# Other JQuery plugins #}
{% addtoblock "js" %}<script src="{% static 'main/3part/jqueryplugins/jquery.cookie.js' %}"></script>{% endaddtoblock %}
{% addtoblock "js" %}<script src="{% static 'main/3part/jqueryplugins/jquery.PrintArea.js' %}"></script>{% endaddtoblock %}

<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:"en" }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Chcem Vedie≈•{% endblock %}</title>
    {% render_block "css" %}
  </head>
  <body>
    <header>
      {% include "main/snippets/header.html" %}
    </header>
    <div class="container">
      {% include "main/snippets/messages.html" %}
      {% block container %}{% endblock %}
    </div>
    <footer class="container">
      <hr>
      {% include "main/snippets/footer.html" %}
    </footer>
    {% render_block "js" %}
  </body>
</html>

{% addtoblock "css" %}{# {{{ #}
  <style>
	/* Make sure fixed menu won't overlap page top. */
	@media (min-width: 980px) { body { padding-top: 60px; } }

	/* Some tweaks for Bootstrap. */
	.brand.active { color: white; }
	.well-inverse { background-color: white; }
	.suppressed-control { padding: 5px; height: 20px; line-height: 20px; display: inline-block; vertical-align: center; }

	/* Large Bootstrap modals */
	@media (min-width: 768px) { .modal.modal-large { width: 660px; margin-left: -330px; } }
	@media (min-width: 980px) { .modal.modal-large { width: 870px; margin-left: -435px; } }
	@media (min-width: 1200px) { .modal.modal-large { width: 1100px; margin-left: -550px; } }

	/* Naive workaround for responsive tall modals */
	@media (min-height: 650px) { .modal-body { max-height: 450px; } }
	@media (min-height: 700px) { .modal-body { max-height: 500px; } }
	@media (min-height: 750px) { .modal-body { max-height: 550px; } }
	@media (min-height: 800px) { .modal-body { max-height: 600px; } }
	@media (min-height: 850px) { .modal-body { max-height: 650px; } }
	@media (min-height: 900px) { .modal-body { max-height: 700px; } }
	@media (min-height: 950px) { .modal-body { max-height: 750px; } }
	@media (min-height: 1000px) { .modal-body { max-height: 800px; } }
	@media (min-width: 768px) and (min-height: 750px) { .modal-body { max-height: 450px; } }
	@media (min-width: 768px) and (min-height: 800px) { .modal-body { max-height: 500px; } }
	@media (min-width: 768px) and (min-height: 850px) { .modal-body { max-height: 550px; } }
	@media (min-width: 768px) and (min-height: 900px) { .modal-body { max-height: 600px; } }
	@media (min-width: 768px) and (min-height: 950px) { .modal-body { max-height: 650px; } }
	@media (min-width: 768px) and (min-height: 1000px) { .modal-body { max-height: 700px; } }

	/* Loading icon and fixing z-index for JQuery Autocomplete */
	.ui-autocomplete-loading { background: white url("{% static 'main/images/ui-anim_basic_16x16.gif' %}") right center no-repeat; }
	.ui-autocomplete { z-index: 1100 !important; /* Must be higher than 1050, what's Bootstrap modal z-index. */ }

	/* For chcemvediet.apps.obligees.forms.ObligeeWithAddressInput */
	.obligee_with_address_input { display: inline-block; vertical-align: top; }
	.obligee_with_address_input ~ .help-inline { padding-top: 5px; }
	.obligee_with_address_input_details { padding: 10px 0px 0px 5px; }
	.obligee_with_address_input_hide { display: none; }

	/* Bootstrap labels with links and close buttoons */
	.label { vertical-align: middle; }
	.label a { color: inherit; vertical-align: middle; text-decoration: none; }
	.label a:hover { text-decoration: none; }
	.label-close { color: #000; opacity: 0.4; padding: 0px; margin-left: 5px; background: none; border: 1px red; font-size: 20px; font-weight: bold; line-height: 20px; text-shadow: 0px 1px 0px #FFF; }

	/* Form file upload button */
	.btn-file { position: relative; overflow: hidden; }
	.btn-file input[type=file] { position: absolute; top: 0; left: 0; min-width: 100%; min-height: 100%; filter: alpha(opacity=0); opacity: 0; cursor: inherit; display: block; }
  </style>
{% endaddtoblock %}{# }}} #}

{% addtoblock "js" %}{# {{{ #}
  <script>
	/* Scrolls to selected element. If there is no such element, do nothing.
	 *
	 * Example:
	 *     $('#element').scrollTo()
	 */
	$(function(){
		$.fn.scrollTo = function(){
			if (this.length) {
				var skip = parseInt($('body').css('padding-top'));
				var top = this.offset().top - skip;
				$('html, body').animate({
					scrollTop: top
				}, 200);
			}
		};
	});

	/* Bootstrap modals are animated. This function closes any open modals, waits for the
	 * animation and then call the given callback.
	 *
	 * Example:
	 *     $.hideBootstrapModal(function(){ console.log('Modals closed.'); });
	 */
	$(function(){
		$.hideBootstrapModal = function(then){
			if ($('.modal.in').length) {
				$('body').on('hidden.hideBootstrapModal', '.modal', function(){
					$('body').off('.hideBootstrapModal');
					then();
				});
				$('.modal.in').modal('hide');
			} else {
				then();
			}
		};
	});

	/* Bootstrap modals are not recursive by default. Use this function if you want to show
	 * a submodal while already showing another modal.
	 *
	 * Example:
	 *     $('#some-modal').modal('show');
	 *     ...
	 *     $('#another-modal').subModal();
	 */
	$(function(){
		$.fn.subModal = function(){
			var layers = $('.modal-backdrop');
			this.modal('show');
			this.css('z-index', parseInt(this.css('z-index')) + 30*layers.length);
			var backdrop = $('.modal-backdrop').not(layers);
			backdrop.css('z-index', parseInt(backdrop.css('z-index')) + 30*layers.length);
		};
	});

	/* Intercepts clicks on elements with class ``confirm`` and asks user if he is sure he
	 * wants to proceed. Question to ask is read from ``data-confirm``.
	 *
	 * This function must be defined before any other function attaching handlers to events
	 * we need to prevent if the user decides not to proceed.
	 *
	 * Example:
	 *     <button type="submit" class="confirm" data-confirm="Are you sure?">Submit</button>
	 */
	$(function(){
		$('.confirm').click(function(event){
			var message = $(this).data('confirm');
			if (!confirm(message)) {
				event.preventDefault();
				event.stopImmediatePropagation();
			}
		});
	});

	/* Makes every link with class ``post`` send POST request to its href URL when clicked.
	 * Data for the request may be supplied by ``data-post-*`` element attributes.
	 *
	 * Example:
	 *     <a href="/path/to/location" class="post" data-post-name="value">...</a>
	 */
	$(function(){
		$('a.post').click(function(event){
			event.preventDefault();
			var form = $('<form action="" method="post" style="display: none;"></form>');
			form.attr('action', $(this).attr('href'));

			$.each(this.attributes, function(){
				if (this.name.substring(0, 10) == "data-post-") {
					var input = $('<input type="hidden" name="" value="">');
					input.attr('name', this.name.substring(10));
					input.attr('value', this.value);
					input.appendTo(form);
				}
			});

			form.appendTo('body');
			form.submit();
		});
	});

	/* Attaches JQuery Datepicker to all elements (usually input boxes) with class
	 * ``datepicker``. Datepicker is attached when the user focuses the element for the first
	 * time. We cannot just attach it to elements with correct class when the page loads,
	 * because some elements may be inserted to the page later, e.g. with AJAX. The Datepicker
	 * is configured to have current locale.
	 *
	 * Example:
	 *     <input type="text" class="datepicker" value="12/31/2014">
	 */
	$(function(){
		$(document).on('focus', '.datepicker', function(event){
			if (!$(this).hasClass('hasDatepicker')) {
				var lang = $('html').attr('lang');
				$(this).datepicker($.datepicker.regional[lang == 'en' ? '' : lang]);
				$(this).datepicker('show');
			}
		});
	});

	/* Attaches JQuery Autocomplete to all elements (usually input boxes) with class
	 * ``autocomplete``. Autocomplete is attached when the user focuses the element for the
	 * first time. We cannot just attach it to elements with correct class when the page loads,
	 * because some elements may be inserted to the page later, e.g. with AJAX. Autocomplete
	 * source url must be given in ``data-autocomplete-url`` attribute.
	 *
	 * Example:
	 *     <input type="text" class="autocomplete" data-autocomplete-url="/autocomplete/url">
	 */
	$(function(){
		$(document).on('focus', '.autocomplete', function(event){
			if (!$(this).hasClass('ui-autocomplete-input')) {
				var source = $(this).data('autocomplete-url');
				$(this).autocomplete({
					source: source,
					minLength: 2
				});
			} else {
				$(this).autocomplete("search");
			}
		});
	});

	/* Attaches ObligeeWithAddressInput to JQuery Autocomplete events and updates Obligee
	 * details whenever the user selects a new Obligee.
	 */
	$(function(){
		function handler(event, ui){
			if (ui.item) {
				var obligee = ui.item.obligee;
				$('.obligee_with_address_input_street', this).text(obligee.street);
				$('.obligee_with_address_input_zip', this).text(obligee.zip);
				$('.obligee_with_address_input_city', this).text(obligee.city);
				$('.obligee_with_address_input_email', this).text(obligee.emails);
				$('.obligee_with_address_input_details', this).show();
			} else {
				$('.obligee_with_address_input_details', this).hide();
			}
		}
		$(document).on('autocompleteselect', '.obligee_with_address_input', handler);
		$(document).on('autocompletechange', '.obligee_with_address_input', handler);
	});

	/* Clicking on elements with class ``print`` prints element specified by ``data-target``
	 * attribute.
	 *
	 * Requires JQuery plugin: PrintArea
	 * http://plugins.jquery.com/PrintArea/
	 *
	 * Example:
	 *     <button type="button" class="print" data-target="#print-area">Print</button>
	 *     <div id="#print-area">...</div>
	 */
	$(function(){
		$(document).on('click', '.print', function(event){
			event.preventDefault();
			var target = $(this).data('target');
			$(target).printArea();
		});
	});

	/* Clicking on element with class ``reload`` reloads the page.
	 *
	 * Example:
	 *     <button type="button" class="reload">Reload</button>
	 */
	$(function(){
		$(document).on('click', '.reload', function(event){
			event.preventDefault();
			location.reload();
		});
	});

	/* Attaches JQuery File Upload to file inputs with class ``fileupload``.
	 *
	 * Attributes:
	 *  -- data-url: URL where the files upload to.
	 *  -- data-field: Hidden input box where to keep the list of uploaded files.
	 *  -- data-target: Container where to show the list of uploaded files. The target should
	 *         contain a hidden child with class ``fileupload-template`` which content will be
	 *         used as a template for the list of uploaded files.
	 *
	 * Example:
	 *     <input class="fileupload" type="file" name="files" multiple data-url="..." data-field="#field" data-target="#target">
	 *
	 *     <span id="target">
	 *       <span class="fileupload-template hide">...</span>
	 *     </span>
	 *
	 *     <form>
	 *       ...
	 *       <input id="field" type="hidden" name="...">
	 *       ...
	 *     </form>
	 */
	$(function(){
		function attach(base){
			$(base).find('.fileupload').not('.hasFileupload').addClass('hasFileupload').each(function(){
				var target = $(this).data('target');
				var field = $(this).data('field');
				$(target).data('field', field);
				$(this).fileupload({
					dataType: 'json',
					singleFileUploads: false,
					formData: {'csrfmiddlewaretoken': $.cookie('csrftoken')},
				})
			});
		};
		$(document).on('fileuploaddone', '.fileupload', function(event, data){
			var target = $(this).data('target');
			var field = $(this).data('field');
			var template = $(target).find('.fileupload-template');
			data.result.files.forEach(function(file){
				var label = $($(template).html());
				$(label).data('attachment', file.id);
				$(label).find('a').attr('href', file.url).html(file.name);
				$(target).append(label).append(' ');
				$(field).val($(field).val() + ',' + file.id + ',');
			});
		});
		$(document).on('click', '.fileupload-label-close', function(event){
			var label = $(this).parents('.fileupload-label');
			var attachment = $(label).data('attachment');
			var target = $(label).parent();
			var field = $(target).data('field');
			$(label).hide(300, function(){ $(this).remove(); });
			$(field).val($(field).val().replace(','+attachment+',', ','));
		});
		$(document).on('dom-changed', function(event){ attach(event.target); });
		attach(document);
	});

	/* Performs AJAX call expecting JDOT (JSON DOM Transition) response generated by
	 * ``poleno.utils.http.Jdot``. It's a list of simple javascript snippents to transform the
	 * page.
	 *
	 * Example:
	 *     <form class="jdot" method="post" action="...">...</form>
	 *     <button class="jdot" action="...">...</button>
	 *     <a class="jdot" href="..." method="post">...</a>
	 *
	 * FIXME: Deprecated?
	 */
	$(function(){
		function handler(event){
			event.preventDefault();
			$.ajax({
				type: $(this).attr('method') || 'get',
				url: $(this).attr('action') || $(this).attr('href'),
				data: $(this).serialize(),
				dataType: 'json',
			}).done(function(data){
				for (var i = 0; i < data.jdot.length; i++) {
					(function(args){ eval(data.jdot[i].js); })(data.jdot[i].args);
				}
			});
		}
		$(document).on('submit', 'form.jdot', handler);
		$(document).on('click', ':not(form).jdot', handler);
	});

	/* Perform AJAX request when clicked on an element or submitted a form with class ``ajax``.
	 * Response data are returned by ``ajax-done`` event which is triggered on the element when
	 * the request finishes. If the request fails, ``ajax-fail`` is triggered.
	 *
	 * Attributes:
	 *     ``method``: Set HTTP method used for the request, e.g. "POST". If not specified
	 *             GET method is used.
	 *     ``action``, ``href``: Set request url.
	 *     ``data-type``: Set AJAX response data type, e.g. "json" or "html".
	 *
	 * Example:
	 *     <form class="ajax" method="post" action="...">...</form>
	 *     <button class="ajax" action="...">...</button>
	 *     <a class="ajax" href="..." method="post">...</a>
	 *
	 *     $('form').on('ajax-done', function(event, data){...})
	 *     $('form').on('ajax-fail', function(event){...})
	 */
	$(function(){
		function handler(event){
			event.preventDefault();
			var type = $(this).attr('method') || 'get';
			var url = $(this).attr('action') || $(this).attr('href');
			var data = $(this).serialize();
			var dataType = $(this).data('type') || 'json';
			var that = this;
			$.ajax({
				type: type,
				url: url,
				data: data,
				dataType: dataType
			}).done(function(data){
				$(that).trigger('ajax-done', [data]);
			}).fail(function(){
				$(that).trigger('ajax-fail');
			});
			// See ``button_workaround`` below
			$(this).find('.ajax-button-workaround').remove();
		}
		$(document).on('submit', 'form.ajax', handler);
		$(document).on('click', ':not(form).ajax', handler);

		// Submit event does not know which submit button was clicked. Therefore we must
		// catch all clicks on such buttons and store their value in a hidden input. We
		// must remember to reset these values after the AJAX request is made, so they won't
		// mess with future submits.
		function button_workaround(event){
			var form = $(this).parents('form.ajax');
			var hidden = form.find('.ajax-button-workaround');
			if (hidden.length == 0) {
				hidden = $('<input class="ajax-button-workaround" type="hidden">').appendTo(form);
			}
			hidden.attr('name', $(this).attr('name'));
			hidden.attr('value', $(this).attr('value'));
		}
		$(document).on('click', 'form.ajax button[type="submit"]', button_workaround)
		$(document).on('click', 'form.ajax input[type="submit"]', button_workaround)
	});

	/* Takes data returned by an Ajax request and shows them in a modal. Then disables the Ajax
	 * on the element and configures the modal to directly show given data on any further
	 * clicks. After inserting returned data into the modal, emits ``dom-changed`` event on the
	 * modal.
	 *
	 * Attributes:
	 *     ``target``: Selector of modal element where to put response data. The element should
	 *             have class ``modal``.
	 *     ``fail-target``: Selector of modal element to show if the request fails.
	 *
	 * Example:
	 *     <button class="ajax ajax-modal-once" action="..." target="#done" fail-target="#fail">...</button>
	 *     <div id="done" class="modal hide fade">This will be replaced with response data</div>
	 *     <div id="fail" class="modal hide fade">Ajax failed.</div>
	 */
	$(function(){
		function done(event, data){
			var target = $(this).data('target');
			$(target).html(data).trigger('dom-changed').modal('show');
			$(this).removeClass('ajax ajax-modal-once');
			$(this).attr('data-toggle', 'modal');
		}
		function fail(event){
			var target = $(this).data('fail-target');
			$(target).modal('show');
		}
		$(document).on('ajax-done', '.ajax-modal-once', done);
		$(document).on('ajax-fail', '.ajax-modal-once', fail);
	});

  </script>
{% endaddtoblock %}{# }}} #}

